/**
 * Created by rubfag on 18.06.2015.
 */

tinymce.PluginManager.add('aksess_inserttable', function(editor, url){

    function createTablePopupWindow() {
        var modifyExisting = false;
        var tblElm = editor.dom.getParent(editor.selection.getNode(), 'table');
        if (tblElm) {
            modifyExisting = true;
        }

        editor.windowManager.open({
            title:"Create table",
            url: properties.contextPath +"/"+ "publish/popups/InsertTable.action?edit=" + encodeURI(modifyExisting),
            iframe: false,
            width: 600,
            height: 400
        });
    }

    function makeLixScorePopupWindow() {
        var s = editor.getContent();

        var longwords = 0;
        var words = 0;
        var lix = 0;

        //s = se.getContent();
        //strip the html
        s = s.replace(/(<([^>]+)>)/ig,"");
        s = s.replace(/&nbsp;/g,"");

        // Replace newlines with spaces.
        s = s.replace(/\/n/, ' ');
        // Remove trailing spaces.
        s = s.replace(/ $/, '');
        // Remove everything that isn't a space, period or regular character.
        s = s.replace(/[^A-Za-z0-9\.\?!: ]/g, '');

        // norwegian chars
        s = s.replace(/oslash/gi, "o");
        s = s.replace(/aring/gi, "a");
        s = s.replace(/aelig/gi, "e");

        if (s.length == 0) {
            return false;
        }
        // If the last character isn't an end-of-sentence character we add one
        var last = s.charAt(s.length-1);
        if (last != '.' && last != '?' && last != '!' && last != ':') {
            s = s+'.';
        }
        // Get gross length
        var length = s.length;
        // Remove end-of-sentence characters.
        s = s.replace(/[\.\?!:]/g, '');
        // Get number of sentences and word count
        var sentences = length-s.length;
        words = s.split(' ');
        wcount = words.length;

        // Check for long words.
        for (i in words) {
            if (words[i].length > 6) {
                longwords++;
            }
        }

        lix = Math.round(wcount / sentences + 100 * longwords / wcount);

        editor.windowManager.open({
            //title:"Lix number",
            url: properties.contextPath +"/"+ "admin/publish/popups/Lix.action?lix="+lix+"&wc="+wcount+"&lwc="+longwords+"&sent="+sentences,
            //url: "/popups/Lix.action?lix="+lix+"&wc="+wcount+"&lwc="+longwords+"&sent="+sentences,
            iframe: false,
            width: 400,
            height: 180
        });
    }

    // Add a button that opens a window
    editor.addButton('aksess_inserttable', {
        tooltip: 'Create/edit table',
        icon: 'table',
        onclick: createTablePopupWindow
    });

    // Adds a new item to the insert menu
    editor.addMenuItem('aksess_inserttable', {
        text: 'Create/edit table',
        icon: 'table',
        context: 'insert',
        onclick: createTablePopupWindow
    });

    editor
});